<!doctype html>
<head>

    <title> 
        The Canvas
    </title>

    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>

    <script type="text/javascript" charset="utf-8">
        var socket = io.connect(location.origin, {transports:['websocket']});
        var colors = [
            '#FFFFFF',
            '#888888',
            '#212121',
            '#FFA7D0',
            '#E20000',
            '#E59500',
            '#A06B43',
            '#E6D802',
            '#94E040',
            '#09BF00',
            '#00D3DC',
            '#0085C6',
            '#0700EB',
            '#CD6DE2',
            '#81007E'
        ];
    </script>

    <script type="text/javascript" charset="utf-8">

        function colorFlagToColor(flag) {
            if(flag >= 0 && flag < colors.length){
                return colors[flag];
            } else {
                return colors[2];
            }
        }

        function posFromEvent(event) {
            eventX = event.pageX - canvas.offsetLeft;
            eventY = event.pageY - canvas.offsetTop;
            return {x: eventX, y: eventY};
        }

        function bytesToLine(bytes) {
            const startX = bytes.getInt16(0);
            const startY = bytes.getInt16(2);
            const endX = bytes.getInt16(4);
            const endY = bytes.getInt16(6);
            const c = colorFlagToColor(bytes.getUint8(8));
            return {
                start: {
                    x: startX,
                    y: startY
                },
                end: {
                    x: endX,
                    y: endY
                },
                color: c
            };
        }

        function lineToBytes(line) {
            const buffer = new ArrayBuffer(9);
            const dv = new DataView(buffer);
            dv.setInt16(0, line.start.x);
            dv.setInt16(2, line.start.y);
            dv.setInt16(4, line.end.x);
            dv.setInt16(6, line.end.y);
            dv.setUint8(8, line.color);
            return buffer;
        }

        function drawLine(line) {
            ctx.beginPath();
            ctx.moveTo(line.start.x, line.start.y);
            ctx.lineTo(line.end.x, line.end.y);
            ctx.strokeStyle = line.color;
            ctx.lineWidth = 1;
            ctx.stroke();
            ctx.closePath();
        }

        function sendLine(line) {
            socket.emit('d', lineToBytes(line));
        }

        function isOnCanvas(line) {
            return (line.end.x >= 0 && line.end.y >= 0) || (line.start.x >= 0 && line.start.y >= 0);
        }

        function range(low=0, high) {
            var list = [];
            for (var i = low; i < high; i++) {
                list.push(i);
            }
            return list
        }

    </script>

    <script type="text/javascript" charset="utf-8">
        socket.on('r', (bytes) => drawLine(bytesToLine(new DataView(bytes))));
    </script>

    <script type="text/javascript" charset="utf-8">

        var canvas, ctx;

        const initCursor = {
            drawing: false,
            line: {
                start: undefined,
                end: undefined,
                color: 2
            }
        };

        let cursor = initCursor;

        function initColors() {
            const topRow = document.getElementById("colorRow0");

            range(low=0, colors.length)
                .map(i => "color" + i)
                .forEach((id, idx) => {
                        let thisSelector = topRow.insertCell();
                        thisSelector.style.background = colorFlagToColor(idx);
                        thisSelector.style.width = "30px";
                        thisSelector.style.height = "30px";
                        thisSelector.setAttribute("class", "colorSelector");
                        thisSelector.onclick = () => {
                            let selectors = document.getElementsByClassName("colorSelector");
                            [].forEach.call(selectors, (selector) => selector.classList.remove("selected"));
                            thisSelector.classList.add("selected");
                            cursor.line.color = idx;
                        }
                        
                });
        };

        function initCanvas() {

            canvas = document.getElementById("mainCanvas");
            ctx = canvas.getContext("2d");

            document.body.addEventListener('mousedown', function(event) {
                if(event.which == 1){
                    cursor.line.start = posFromEvent(event);
                    cursor.drawing = true;
                }
            })

            document.body.addEventListener('mouseleave', function(event) {
                cursor.drawing = false
            });

            document.body.addEventListener('mousemove', function(event) {
                pos = posFromEvent(event);
                if(cursor.drawing) {
                    cursor.line.end = posFromEvent(event);
                    if(isOnCanvas(cursor.line)){
                        sendLine(cursor.line);
                    }
                    cursor.line.start = pos;
                }
            });

            document.body.addEventListener('mouseup', function(event) {
                if(event.which == 1){
                    cursor.drawing = false;
                }
            });

            ctx.height = 8000;
            ctx.width = 16000;
        }

        function init() {
            initCanvas();
            initColors();
        }

    </script>

    <style type="text/css">
        canvas {
            margin: auto;
            position: absolute;
            z-index: 0;
            height: 800px;
            width: 1600px;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
        }

        body {
            position: relative;
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            min-height: 800px;
            min-width: 1600px;
        }

        #colorSelectors {
            z-index: 1;
            background-color: white;
            border: 3px solid black;
            border-radius: 5px;
            position: fixed;
            top:10px;
            left:10px;
        }

        .colorSelector:hover {
            transform: scale(0.85);
        }

        .selected {
            transform: scale(0.7) !important;
        }

    </style>
    
</head>

<body style="background-color:#434343;" onload="init()">
    <table id="colorSelectors">
        <tr id="colorRow0"></tr>
    </table>
    <div>
        <canvas id="mainCanvas" width="1600px" height="800px"></canvas>
    </div>
</body>       